---
title: HTTP 缓存机制
date: 2018-04-16 11:57:13
tags: 前端学习总结
---

# 彻底弄懂 HTTP 缓存机制

[参考链接](https://www.cnblogs.com/chenqf/p/6386163.html)

[参考2](https://segmentfault.com/a/1190000008956069)

缓存在前端面试中经常被问到，必须彻底弄懂机制。

## Http 缓存分为两类

1. 强缓存

2. 协商缓存

###  强缓存

第一次请求（还没有缓存的时候），服务器会将数据和缓存规则一起返回，客户端进行缓存。两个字段标明缓存失效规则。
1. `Expires` 到期时间（服务端时间）http1.0时代用这个，现在浏览器均默认http1.1，并且由于客户端时间和服务端时间可能存在误差，http1.1的版本使用`Cache-Control`替代。
2. `Cache-Control` 相对时间，max-age=xxx（单位： 秒）；在指定时间内，直接使用缓存资源。

### 协商缓存

需要和服务器进行协商对比判断是否可以使用缓存。
第一次请求数据时，服务器会将缓存标识和数据一起返回，客户端将两者进行缓存备份。再次请求时，客户端将缓存标识一并发送，服务端根据缓存标识判断客户端是否可以直接使用缓存，判断成功，返回304状态码。
1. `Last-Modified`  （服务器返回首部字段）浏览器首次请求，服务器在响应请求时，告诉浏览器资源最后被修改的时间
2. `Last-Modified-Since` （客户端发送的首部字段）浏览器再次请求， 该字段保存的就是首次请求服务器返回的`Last-Modified` 值，服务器拿到该值后进行对比，若值未变则返回304状态码，若该值小于服务器端的值，说明资源已被更新，服务器返回新的资源，返回成功状态码200OK；
3. `Etag` 第一次请求时，服务器返回的资源唯一标识。
4. `If-None-Match`  再次请求服务器，客户端将缓存的资源唯一标识以这个首部字段进行发送，客户端拿到这个值进行对比，若一样，则返回304，通知浏览器可以直接使用浏览器的缓存；若不一样，说明资源有改动，服务器响应新的资源。

#### 浏览器首次请求
![image](https://images2015.cnblogs.com/blog/632130/201702/632130-20170210142134291-1976923079.png)

#### 浏览器再次请求
![image](https://images2015.cnblogs.com/blog/632130/201702/632130-20170210141453338-1263276228.png)

## 总结

1. 第一次请求缓存资源后（也有可能不缓存 如果第一次请求服务器返回的 `Cache-Control` 值为`no-store` 则所有的资源都不会被缓存），浏览器再次请求时，先判断缓存资源是否过期，如果没有过期则直接取得缓存资源，不用再请求服务器。
2. 若过期，则进行协商缓存（缓存资源若没有被修改则仍然有效），服务器根据客户端请求发送的资源唯一标识符（`Last-Modified-Since`和`If-None-Match`）和服务器端的值（`Last-Modified`和`Etag`）进行对比，对比成功则返回304，告知服务器端可以直接使用浏览器端缓存资源。

## 附：HTTP状态码

1XX：服务器收到请求，请求i进行中

2XX：请求成功，200 OK

3XX：重定向，需要进一步的操作以完成请求。301 永久重定向；302 临时重定向；304 not modified

4XX：客户端错误，401 Unauthorized（未授权）403 Forbidden（禁止访问） 404 not found（资源未找到）

5XX：服务器错误，500 Internal Server Error（服务器内部错误，无法完成请求）； 502 Bad Gateway（网关错误）；  503 Service Unavailable（服务器临时宕机）；505 HTTP Version not supported（服务器不支持请求的 http 版本）